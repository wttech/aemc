#!/usr/bin/env sh

VERSION=${TASK_VERSION:-"3.40.0"}

# Check required tools
# ====================

check_command() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "Error! Required command '$1' is not installed"
    exit 1
  fi
}

check_command curl
check_command uname

check_archive_tools() {
  if [ "$1" = "windows" ]; then
    check_command unzip
  else
    check_command tar
    check_command gzip
  fi
}

# Define API
# ==========

# https://github.com/client9/shlib/blob/master/uname_os.sh
detect_os() {
  os=$(uname -s | tr '[:upper:]' '[:lower:]')

  # fixed up for https://github.com/client9/shlib/issues/3
  case "$os" in
    msys*) os="windows" ;;
    mingw*) os="windows" ;;
    cygwin*) os="windows" ;;
    win*) os="windows" ;; # for windows busybox and like # https://frippery.org/busybox/
  esac

  # other fixups here
  echo "$os"
}

# https://github.com/client9/shlib/blob/master/uname_arch.sh
detect_arch() {
  arch=$(uname -m)
  case $arch in
    x86_64) arch="amd64" ;;
    x86) arch="386" ;;
    i686) arch="386" ;;
    i386) arch="386" ;;
    aarch64) arch="arm64" ;;
    armv5*) arch="armv5" ;;
    armv6*) arch="armv6" ;;
    armv7*) arch="armv7" ;;
  esac
  echo "${arch}"
}

# https://github.com/client9/shlib/blob/master/http_download.sh
download_file() {
  local_file=$1
  source_url=$2
  header=$3
  attempt=1
  max_attempts=3
  while [ $attempt -le $max_attempts ]; do
    if [ -z "$header" ]; then
      code=$(curl -w '%{http_code}' -skL --connect-timeout 30 --max-time 300 -o "$local_file" "$source_url")
    else
      code=$(curl -w '%{http_code}' -skL --connect-timeout 30 --max-time 300 -H "$header" -o "$local_file" "$source_url")
    fi
    if [ "$code" = "200" ]; then
      return 0
    fi
    if [ "$code" = "000" ]; then
      echo "Warning: Cannot connect to '$source_url' (SSL/network issue). Try manual download. (attempt $attempt/$max_attempts)"
    else
      echo "Warning: Downloading file from URL '$source_url' received HTTP status '$code' (attempt $attempt/$max_attempts)"
    fi
    rm -f "$local_file"
    if [ $attempt -lt $max_attempts ]; then
      sleep 3
    fi
    attempt=$((attempt + 1))
  done
  echo "Error! Downloading file from URL '$source_url' failed after $max_attempts attempts"
  return 1
}

download_file_once () {
  URL=$1
  FILE=$2
  if [ ! -f "${FILE}" ]; then
      mkdir -p "$(dirname "$FILE")"
      FILE_TMP="$2.tmp"
      if ! download_file "$FILE_TMP" "$URL"; then
        rm -f "$FILE_TMP"
        return 1
      fi
      mv "$FILE_TMP" "$FILE"
  fi
}

unarchive_file() {
  FILE=$1
  DIR=$2

  rm -fr "$DIR"
  mkdir -p "$DIR"
  if [ "${FILE##*.}" = "zip" ] ; then
    if ! unzip -t "$FILE" > /dev/null 2>&1; then
      echo "Error! Archive file '$FILE' is corrupted or not a valid zip"
      return 1
    fi
    unzip "$FILE" -d "$DIR"
  else
    if ! gzip -t "$FILE" 2>/dev/null; then
      echo "Error! Archive file '$FILE' is corrupted or not a valid gzip"
      return 1
    fi
    tar -xf "$FILE" -C "$DIR"
  fi
}


# Download tool
# =============

OS=$(detect_os)
ARCH=$(detect_arch)

check_archive_tools "$OS"

AEM_DIR="aem"
HOME_DIR="${AEM_DIR}/home"
DOWNLOAD_DIR="${HOME_DIR}/opt"

BIN_DOWNLOAD_NAME="task"
BIN_ARCHIVE_EXT="tar.gz"
if [ "$OS" = "windows" ] ; then
  BIN_ARCHIVE_EXT="zip"
fi
BIN_DOWNLOAD_URL="https://github.com/go-task/task/releases/download/v${VERSION}/${BIN_DOWNLOAD_NAME}_${OS}_${ARCH}.${BIN_ARCHIVE_EXT}"
BIN_ROOT="${DOWNLOAD_DIR}/${BIN_DOWNLOAD_NAME}/${VERSION}"
BIN_ARCHIVE_FILE="${BIN_ROOT}/${BIN_DOWNLOAD_NAME}.${BIN_ARCHIVE_EXT}"
BIN_ARCHIVE_DIR="${BIN_ROOT}/${BIN_DOWNLOAD_NAME}"
BIN_NAME="task"
BIN_EXEC_FILE="${BIN_ARCHIVE_DIR}/${BIN_NAME}"

if [ ! -f "${BIN_EXEC_FILE}" ]; then
  mkdir -p "${BIN_ARCHIVE_DIR}"
  if ! download_file_once "${BIN_DOWNLOAD_URL}" "${BIN_ARCHIVE_FILE}"; then
    echo "Error! Cannot download Task CLI"
    echo "Manual download: ${BIN_DOWNLOAD_URL}"
    echo "Place the file at: ${BIN_ARCHIVE_FILE}"
    exit 1
  fi
  if ! unarchive_file "${BIN_ARCHIVE_FILE}" "${BIN_ARCHIVE_DIR}"; then
    rm -f "${BIN_ARCHIVE_FILE}"
    echo "Error! Cannot unarchive Task CLI"
    exit 1
  fi
  if [ ! -f "${BIN_EXEC_FILE}" ]; then
    echo "Error! Task CLI binary '${BIN_EXEC_FILE}' not found after extraction"
    exit 1
  fi
  chmod +x "${BIN_EXEC_FILE}"
fi

# Prevent OS or shell-specific glitches
# =====================================

# https://stackoverflow.com/questions/7250130/how-to-stop-mingw-and-msys-from-mangling-path-names-given-at-the-command-line
export MSYS_NO_PATHCONV=1
export MSYS2_ARG_CONV_EXCL="*"
export MSYS2_ENV_CONV_EXCL="*"

# Execute Task Tool
# =================

# https://taskfile.dev/api/#env
export TASK_COLOR_GREEN=35

# https://taskfile.dev/experiments/env-precedence
export TASK_X_ENV_PRECEDENCE=1

"./${BIN_EXEC_FILE}" "$@"
